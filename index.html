<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <!-- ✅ важно для телефонов -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Каталог коллекционера</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#0b0f1a;
      --text:#eaf0ff;
      --muted:#9fb0d0;
      --brand:#7c5cff;
      --brand2:#00d4ff;
      --danger:#ff4d6d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;

      --site-hero: radial-gradient(1200px 600px at 20% 0%, rgba(124,92,255,.25), transparent 60%),
                   radial-gradient(900px 500px at 90% 10%, rgba(0,212,255,.18), transparent 55%);

      /* ✅ отступы “окна” модалки от краёв */
      --modal-inset: clamp(12px, 3.5vw, 28px);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: var(--site-hero), var(--bg);
      color:var(--text);
      overflow-x: hidden; /* ✅ страховка от горизонтального скролла */
    }

    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,26,.72);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}

    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    h1{font-size:18px; margin:0; line-height:1.15}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.55);
    }
    .tab{
      border: none;
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      color: var(--muted);
      background: transparent;
      font-weight: 800;
    }
    .tab[aria-selected="true"]{
      color: var(--text);
      background: linear-gradient(135deg, rgba(124,92,255,.85), rgba(0,212,255,.55));
    }

    input, select, button, textarea{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.85);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      min-width: 0;
    }
    textarea{min-height:90px; resize: vertical}
    input::placeholder{color:rgba(159,176,208,.75)}

    .btn{
      cursor:pointer;
      border: none;
      font-weight: 900;
      padding: 11px 14px;
      transition: transform .06s ease;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(0,212,255,.70));
    }
    .btn:active{transform: scale(.98)}
    .btnGhost{
      background: rgba(18,26,42,.75);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      cursor:pointer;
    }
    .btnDanger{
      background: rgba(255,77,109,.18);
      border: 1px solid rgba(255,77,109,.35);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.3fr .85fr .85fr .95fr auto auto;
      gap:10px;
      align-items:center;
      width:100%;
      margin-top:12px;
    }

    /* ✅ адаптация фильтров под телефон */
    @media (max-width: 980px){
      .controls{grid-template-columns: 1fr 1fr 1fr; }
    }
    @media (max-width: 560px){
      .controls{grid-template-columns: 1fr; }
      .row{width:100%}
      .tabs{width:100%}
      .tab{flex:1}
      #currency, #langBtn, #addBtn{flex:1}
    }

    main{padding: 16px 0 40px}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    .card{
      grid-column: span 4;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      min-width: 0;
    }
    @media (max-width: 980px){ .card{grid-column: span 6;} }
    @media (max-width: 620px){ .card{grid-column: span 12;} }

    .thumb{
      height: 130px;
      background: linear-gradient(135deg, rgba(124,92,255,.25), rgba(0,212,255,.18));
      display:flex; align-items:flex-end; justify-content:space-between;
      padding: 12px;
      gap:10px;
      position:relative;
    }
    .thumb.hasPhoto{
      background-size: cover;
      background-position: center;
    }
    .thumb.hasPhoto::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.55));
    }
    .thumb > *{position:relative; z-index:1;}

    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }

    .body{padding: 12px 12px 14px}
    .title{font-weight: 950; margin:0; font-size: 15px; line-height: 1.25}
    .money{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
      font-size: 12.5px;
    }
    .money span{
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
    }
    .actions{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    .actions button{flex:1}

    /* ✅ модалка = “окно”, не прилипает к краям */
    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: var(--modal-inset);
      z-index:100;
      overscroll-behavior: contain;
    }
    .modalBackdrop[aria-hidden="false"]{display:flex;}

    .modal{
      width: min(920px, calc(100vw - (var(--modal-inset) * 2)));
      max-height: calc(100dvh - (var(--modal-inset) * 2));
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.94);
      box-shadow: var(--shadow);
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-width: 0;
    }

    /* ✅ на телефоне делаем окно чуть уже и скролл внутри */
    @media (max-width: 560px){
      .modal{
        border-radius: 18px;
      }
    }

    .modalTop{
      padding: 14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      flex: 0 0 auto;
    }
    .modalTop strong{font-size: 14px}
    .x{
      width: 38px; height: 38px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:900;
      flex: 0 0 auto;
    }

    .modalContent{
      padding: 14px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
      min-height: 0;
    }

    .formGrid{
      display:grid; gap:12px;
      grid-template-columns: repeat(12, 1fr);
      min-width: 0;
    }
    .field{grid-column: span 6; display:flex; flex-direction:column; gap:6px; min-width:0}
    .field.full{grid-column: span 12}
    @media (max-width: 760px){ .field{grid-column: span 12} }

    label{color: var(--muted); font-size: 12px}
    .help{color: rgba(159,176,208,.75); font-size: 12px}

    .photoCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      padding: 12px;
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items: start;
      min-width: 0;
    }
    @media (max-width: 560px){
      .photoCard{grid-template-columns: 1fr;}
    }
    .photoPreview{
      width: 140px; height: 140px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      background-size: cover;
      background-position:center;
      box-shadow: var(--shadow);
    }
    @media (max-width: 560px){
      .photoPreview{width: 100%; height: 180px;}
    }
    .photoActions{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      min-width:0;
    }
    .photoActions button{
      flex: 1 1 160px;
      white-space: nowrap;
    }
    .fileHidden{display:none;}

    .empty{
      padding: 22px;
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }

    .hide{display:none !important;}
    .isLocked{opacity:.55; cursor:not-allowed;}
    .lockedHint{ margin-top:6px; font-size:12px; color: rgba(159,176,208,.80); }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0;">
          <h1 id="ui_title">Каталог коллекционера</h1>
          <div class="sub" id="ui_sub">каталог • вишлист • коллекция • заметки • import/export JSON</div>
        </div>
      </div>

      <div class="row">
        <div class="tabs" role="tablist" aria-label="Режимы">
          <button class="tab" id="tab_all" role="tab" aria-selected="true" data-view="all">Каталог</button>
          <button class="tab" id="tab_wish" role="tab" aria-selected="false" data-view="wish">Вишлист</button>
          <button class="tab" id="tab_owned" role="tab" aria-selected="false" data-view="owned">Коллекция</button>
        </div>

        <select class="btnGhost" id="currency" title="Currency" style="padding: 11px 12px;">
          <option value="CZK">CZK</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="UAH">UAH</option>
          <option value="RUB">RUB</option>
        </select>

        <button class="btnGhost" id="langBtn" title="Switch language">RU / EN</button>
        <button class="btn" id="addBtn">＋ Добавить</button>
      </div>
    </div>

    <div class="controls" role="search">
      <input id="q" placeholder="Поиск…" autocomplete="off"/>
      <select id="brand"><option value="all">Все бренды</option></select>

      <select id="typeFilter" class="hide">
        <option value="all">Все типы</option>
        <option value="doll">Куклы</option>
        <option value="accessory">Аксессуары</option>
      </select>

      <select id="condition" class="hide">
        <option value="all">Любое состояние</option>
        <option value="new">Новое</option>
        <option value="good">Хорошее</option>
        <option value="ok">Ок</option>
        <option value="bad">Плохое</option>
      </select>

      <select id="sort">
        <option value="recent">Сорт: недавние</option>
        <option value="market_desc">Средняя цена: ↓</option>
        <option value="market_asc">Средняя цена: ↑</option>
        <option value="buy_desc">Покупка: ↓</option>
        <option value="buy_asc">Покупка: ↑</option>
        <option value="name_asc">Имя: A→Я</option>
        <option value="name_desc">Имя: Я→A</option>
      </select>

      <button class="btnGhost" id="exportBtn">Экспорт JSON</button>
      <button class="btnGhost" id="importBtn">Импорт JSON</button>
      <input id="importFile" type="file" accept="application/json" hidden />
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <span class="pill" id="stats"></span>
      <span class="pill" id="ui_offline">Всё офлайн. Данные хранятся в браузере (localStorage).</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="list" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" style="display:none; margin-top:14px;">Пусто. Добавь запись или измени фильтры.</div>
</main>

<footer class="wrap" id="ui_footer">Дальше можно расширить каталог и подключить фото.</footer>

<!-- Modal -->
<div class="modalBackdrop" id="modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modalTop">
      <strong id="mTitle">Редактировать</strong>
      <button class="x" id="mClose" aria-label="Закрыть">×</button>
    </div>

    <div class="modalContent">
      <div class="formGrid">

        <div class="field">
          <label>Тип</label>
          <select id="f_type">
            <option value="doll">Кукла</option>
            <option value="accessory">Аксессуар</option>
          </select>
        </div>

        <div class="field">
          <label>Название</label>
          <input id="f_name" placeholder="Напр: Draculaura (Core)" />
          <div class="lockedHint" id="lockedHint" style="display:none;"></div>
        </div>

        <div class="field">
          <label>Бренд</label>
          <select id="f_brand">
            <option>Monster High</option>
            <option>Ever After High</option>
            <option>Barbie</option>
            <option>Другие</option>
          </select>
        </div>

        <div class="field">
          <label>Линейка / серия</label>
          <input id="f_line" placeholder="Напр: G1 базовая / Creeproduction..." />
        </div>

        <div class="field" id="fieldChar">
          <label>Персонаж</label>
          <input id="f_char" placeholder="Напр: Frankie / Clawdeen..." />
        </div>

        <div class="field">
          <label>Год</label>
          <div style="display:flex; gap:8px; min-width:0;">
            <button class="btnGhost" id="yearDec" type="button" style="width:44px; padding:0;">−</button>
            <input id="f_year" type="number" min="1950" max="2100" placeholder="2012" style="flex:1; text-align:center; font-weight:900;">
            <button class="btnGhost" id="yearInc" type="button" style="width:44px; padding:0;">+</button>
          </div>
        </div>

        <div class="field">
          <label>Состояние</label>
          <select id="f_condition">
            <option value="new">Новое</option>
            <option value="good">Хорошее</option>
            <option value="ok">Ок</option>
            <option value="bad">Плохое</option>
          </select>
        </div>

        <div class="field">
          <label>Комплектность</label>
          <select id="f_complete">
            <option value="full">Полная</option>
            <option value="partial">Частичная</option>
            <option value="nude">Nude / без одежды</option>
            <option value="unknown">Не знаю</option>
          </select>
        </div>

        <div class="field">
          <label>Статус</label>
          <select id="f_status">
            <option value="none">Просто в каталоге</option>
            <option value="wish">Вишлист</option>
            <option value="owned">В коллекции</option>
          </select>
        </div>

        <!-- Фото -->
        <div class="field full" id="photoBlock">
          <label>Фотография</label>
          <div class="photoCard">
            <div class="photoPreview" id="photoPreview" aria-label="Photo preview"></div>

            <div style="min-width:0;">
              <div class="photoActions">
                <button class="btnGhost" id="pickPhotoBtn" type="button">Выбрать фото</button>
                <button class="btnGhost" id="clearPhotoBtn" type="button">Убрать фото</button>
              </div>
              <div class="help" style="margin-top:8px;">Фото хранится локально (в браузере). Лучше до ~1–2 МБ.</div>
              <input id="f_photo" class="fileHidden" type="file" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="field">
          <label>Цена покупки</label>
          <input id="f_buy" type="number" min="0" step="1" placeholder="Напр: 950" />
          <div class="help">Если не покупала — оставь пустым.</div>
        </div>

        <div class="field">
          <label>Средняя цена рынка</label>
          <input id="f_market" type="number" min="0" step="1" placeholder="Напр: 1200" />
          <div class="help">Можно заполнять позже.</div>
        </div>

        <div class="field full">
          <label>Заметки</label>
          <textarea id="f_notes" placeholder="Состояние, дефекты, что докупить..."></textarea>
        </div>

        <div class="field full">
          <label>Теги (через запятую)</label>
          <input id="f_tags" placeholder="Напр: g1, core, box" />
        </div>

        <div class="field full" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:4px;">
          <button class="btn" id="saveBtn">Сохранить</button>
          <button class="btnGhost" id="cancelBtn">Отмена</button>
          <button class="btnDanger" id="deleteBtn" style="display:none;">Удалить</button>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  const LS_KEY = "collector_catalog_mobilefix_v1";
  const $ = (s)=>document.querySelector(s);

  // минимальная база, чтобы файл был самодостаточный
  function uid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
  function loadDB(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(arr)) return [];
      return arr;
    }catch{ return []; }
  }
  function saveDB(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

  let db = loadDB();
  let view = "all";
  let editingId = null;
  let pendingPhotoDataUrl = null;

  const listEl = $("#list");
  const emptyEl = $("#empty");
  const statsEl = $("#stats");

  const modal = $("#modal");
  const mTitle = $("#mTitle");
  const mClose = $("#mClose");

  const addBtn = $("#addBtn");
  const saveBtn = $("#saveBtn");
  const cancelBtn = $("#cancelBtn");

  const qEl = $("#q");
  const brandEl = $("#brand");

  const yearDec = $("#yearDec");
  const yearInc = $("#yearInc");

  const photoBlock = $("#photoBlock");
  const photoInput = $("#f_photo");
  const photoPreview = $("#photoPreview");
  const pickPhotoBtn = $("#pickPhotoBtn");
  const clearPhotoBtn = $("#clearPhotoBtn");

  const f = {
    type: $("#f_type"),
    name: $("#f_name"),
    brand: $("#f_brand"),
    line: $("#f_line"),
    char: $("#f_char"),
    year: $("#f_year"),
    condition: $("#f_condition"),
    complete: $("#f_complete"),
    status: $("#f_status"),
    buy: $("#f_buy"),
    market: $("#f_market"),
    notes: $("#f_notes"),
    tags: $("#f_tags")
  };

  function formatMoney(n){
    if(n == null || n === "" || Number.isNaN(Number(n))) return "—";
    return String(Number(n));
  }

  function setPhotoPreview(dataUrl){
    photoPreview.style.backgroundImage = dataUrl ? `url('${dataUrl}')` : "";
  }
  function fileToDataUrl(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(String(reader.result || ""));
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function rebuildBrandFilter(){
    const brands = ["all", ...Array.from(new Set(db.map(x=>x.brand).filter(Boolean)))].sort((a,b)=>a.localeCompare(b,'ru'));
    const current = brandEl.value || "all";
    brandEl.innerHTML = "";
    for(const b of brands){
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = (b==="all") ? "Все бренды" : b;
      brandEl.appendChild(opt);
    }
    brandEl.value = brands.includes(current) ? current : "all";
  }

  function matchesQuery(item, q){
    if(!q) return true;
    const hay = [item.name, item.brand, item.line, item.character, item.notes, (item.tags||[]).join(" ")].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase().trim());
  }

  function getFiltered(){
    const q = qEl.value.trim();
    const b = brandEl.value;
    let arr = db.slice();

    if(view === "wish") arr = arr.filter(x=>x.status==="wish");
    else if(view === "owned") arr = arr.filter(x=>x.status==="owned");

    arr = arr.filter(x=>matchesQuery(x,q));
    if(b!=="all") arr = arr.filter(x=>x.brand===b);
    return arr;
  }

  function render(){
    rebuildBrandFilter();
    const arr = getFiltered();
    statsEl.textContent = `${view}: ${arr.length}/${db.length}`;
    listEl.innerHTML = "";
    emptyEl.style.display = arr.length ? "none" : "block";

    for(const it of arr){
      const card = document.createElement("article");
      card.className = "card";
      const thumbClass = it.photoDataUrl ? "thumb hasPhoto" : "thumb";
      const thumbStyle = it.photoDataUrl ? `style="background-image:url('${it.photoDataUrl.replaceAll("'","\\'")}')"` : "";
      card.innerHTML = `
        <div class="${thumbClass}" ${thumbStyle}>
          <span class="badge">${it.condition || "—"}</span>
          <span class="badge">${it.status || "none"}</span>
        </div>
        <div class="body">
          <h3 class="title">${(it.name || "(без названия)").replaceAll("<","&lt;")}</h3>
          <div class="money">
            <span>Покупка: <b>${formatMoney(it.buyPrice)}</b></span>
            <span>Рынок: <b>${formatMoney(it.marketPrice)}</b></span>
          </div>
          <div class="actions">
            <button class="btn" data-action="edit" data-id="${it.id}">Редактировать</button>
          </div>
        </div>
      `;
      listEl.appendChild(card);
    }
  }

  function fillForm(item){
    f.type.value = item.type || "doll";
    f.name.value = item.name || "";
    f.brand.value = item.brand || "Monster High";
    f.line.value = item.line || "";
    f.char.value = item.character || "";
    f.year.value = item.year ?? "";
    f.condition.value = item.condition || "good";
    f.complete.value = item.complete || "unknown";
    f.status.value = item.status || "none";
    f.buy.value = item.buyPrice ?? "";
    f.market.value = item.marketPrice ?? "";
    f.notes.value = item.notes || "";
    f.tags.value = (item.tags || []).join(", ");
  }

  function readForm(){
    const year = f.year.value === "" ? null : Number(f.year.value);
    const buy = f.buy.value === "" ? null : Number(f.buy.value);
    const market = f.market.value === "" ? null : Number(f.market.value);
    const tags = f.tags.value.split(",").map(x=>x.trim()).filter(Boolean);

    return {
      type: f.type.value,
      name: f.name.value.trim(),
      brand: f.brand.value,
      line: f.line.value.trim(),
      character: f.char.value.trim(),
      year: (year != null && !Number.isNaN(year)) ? year : null,
      condition: f.condition.value,
      complete: f.complete.value,
      status: f.status.value,
      buyPrice: (buy != null && !Number.isNaN(buy)) ? buy : null,
      marketPrice: (market != null && !Number.isNaN(market)) ? market : null,
      notes: f.notes.value.trim(),
      tags,
      photoDataUrl: pendingPhotoDataUrl || null
    };
  }

  function openModal(mode, item){
    modal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";

    pendingPhotoDataUrl = null;
    photoInput.value = "";
    setPhotoPreview(null);

    if(mode==="add"){
      editingId = null;
      mTitle.textContent = "Добавить";
      fillForm({});
      photoBlock.classList.remove("hide");
    }else{
      editingId = item.id;
      mTitle.textContent = "Редактировать";
      fillForm(item);
      pendingPhotoDataUrl = item.photoDataUrl || null;
      setPhotoPreview(pendingPhotoDataUrl);
      photoBlock.classList.remove("hide");
    }
  }

  function closeModal(){
    modal.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
    editingId = null;
    pendingPhotoDataUrl = null;
  }

  function saveItem(){
    const data = readForm();
    if(!data.name) return;

    if(editingId){
      const idx = db.findIndex(x=>x.id===editingId);
      if(idx>=0) db[idx] = { ...db[idx], ...data };
    }else{
      db.unshift({ id: uid(), createdAt: Date.now(), ...data });
    }
    saveDB(db);
    closeModal();
    render();
  }

  function stepYear(delta){
    const cur = (f.year.value === "" ? new Date().getFullYear() : Number(f.year.value));
    const next = cur + delta;
    f.year.value = String(next);
  }

  // события
  addBtn.addEventListener("click", ()=>openModal("add", null));
  mClose.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  saveBtn.addEventListener("click", saveItem);

  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && modal.getAttribute("aria-hidden")==="false") closeModal();
  });

  listEl.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-action]");
    if(!btn) return;
    const id = btn.dataset.id;
    const item = db.find(x=>x.id===id);
    if(item) openModal("edit", item);
  });

  qEl.addEventListener("input", render);
  brandEl.addEventListener("change", render);

  yearDec.addEventListener("click", ()=>stepYear(-1));
  yearInc.addEventListener("click", ()=>stepYear(+1));

  pickPhotoBtn.addEventListener("click", ()=>photoInput.click());
  photoInput.addEventListener("change", async ()=>{
    const file = photoInput.files && photoInput.files[0];
    if(!file) return;
    if(file.size > 2.5 * 1024 * 1024){
      photoInput.value = "";
      return;
    }
    const dataUrl = await fileToDataUrl(file);
    pendingPhotoDataUrl = dataUrl;
    setPhotoPreview(dataUrl);
  });
  clearPhotoBtn.addEventListener("click", ()=>{
    pendingPhotoDataUrl = null;
    photoInput.value = "";
    setPhotoPreview(null);
  });

  // табы
  const tabs = [...document.querySelectorAll(".tab")];
  tabs.forEach(tbtn => tbtn.addEventListener("click", ()=>{
    view = tbtn.dataset.view;
    tabs.forEach(x=>x.setAttribute("aria-selected", x===tbtn ? "true":"false"));
    render();
  }));

  // init
  render();
</script>
</body>
</html>
