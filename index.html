<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä–∞</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#121a2a;
      --card:#0f1626;
      --text:#eaf0ff;
      --muted:#9fb0d0;
      --brand:#7c5cff;
      --brand2:#00d4ff;
      --danger:#ff4d6d;
      --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(0,212,255,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,26,.72);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: var(--shadow);
    }
    h1{font-size:18px; margin:0;}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.55);
    }
    .tab{
      border: none;
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      color: var(--muted);
      background: transparent;
      font-weight: 800;
    }
    .tab[aria-selected="true"]{
      color: var(--text);
      background: linear-gradient(135deg, rgba(124,92,255,.85), rgba(0,212,255,.55));
    }
    input, select, button, textarea{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.85);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      box-shadow: none;
    }
    textarea{min-height:90px; resize: vertical}
    input::placeholder{color:rgba(159,176,208,.75)}
    .btn{
      cursor:pointer;
      border: none;
      font-weight: 900;
      padding: 11px 14px;
      transition: transform .06s ease;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(0,212,255,.70));
    }
    .btn:active{transform: scale(.98)}
    .btnGhost{
      background: rgba(18,26,42,.75);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      cursor:pointer;
    }
    .btnDanger{
      background: rgba(255,77,109,.18);
      border: 1px solid rgba(255,77,109,.35);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    main{padding: 18px 0 40px}
    .controls{
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr .8fr auto auto;
      gap:10px;
      align-items:center;
      width:min(1100px, 100%);
    }
    @media (max-width: 980px){
      .controls{grid-template-columns: 1fr 1fr 1fr; }
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    .card{
      grid-column: span 4;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      position:relative;
    }
    @media (max-width: 980px){ .card{grid-column: span 6;} }
    @media (max-width: 620px){ .card{grid-column: span 12;} }
    .thumb{
      height: 120px;
      background: linear-gradient(135deg, rgba(124,92,255,.25), rgba(0,212,255,.18));
      display:flex; align-items:flex-end; justify-content:space-between;
      padding: 12px;
      gap:10px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.18);}
    .badge.warn{border-color: rgba(255,185,0,.35); background: rgba(255,185,0,.14);}
    .badge.bad{border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.14);}
    .body{padding: 12px 12px 14px}
    .titleRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .title{font-weight: 950; margin:0; font-size: 15px; line-height: 1.25}
    .metaLine{color: var(--muted); font-size: 12.5px; margin-top:6px; line-height:1.35}
    .money{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
      color: rgba(234,240,255,.92);
      font-size: 12.5px;
    }
    .money span{
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
    }
    .actions{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    .actions button{flex:1}
    .empty{
      padding: 22px;
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }

    /* Modal */
    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index:100;
    }
    .modalBackdrop[aria-hidden="false"]{display:flex;}
    .modal{
      width: min(980px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{
      padding: 14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .modalTop strong{font-size: 14px}
    .x{
      width: 38px; height: 38px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:900;
    }
    .modalContent{padding: 14px}
    .formGrid{
      display:grid; gap:12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .field{grid-column: span 6; display:flex; flex-direction:column; gap:6px}
    .field.full{grid-column: span 12}
    @media (max-width: 760px){ .field{grid-column: span 12} }
    label{color: var(--muted); font-size: 12px}
    .help{color: rgba(159,176,208,.75); font-size: 12px}
    footer{color: rgba(159,176,208,.75); font-size: 12px; padding: 10px 0 40px}
    a{color:inherit}

    /* small popup near input (replaces alert) */
    .errorPop{
      position: fixed;
      z-index: 9999;
      max-width: 320px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,77,109,.16);
      border: 1px solid rgba(255,77,109,.38);
      color: var(--text);
      box-shadow: var(--shadow);
      font-size: 13px;
      line-height: 1.25;
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity .12s ease, transform .12s ease;
    }
    .errorPop.show{ opacity: 1; transform: translateY(0); }
    .errorPop:after{
      content:"";
      position:absolute;
      left: 16px;
      top: -7px;
      width: 12px;
      height: 12px;
      background: rgba(255,77,109,.16);
      border-left: 1px solid rgba(255,77,109,.38);
      border-top: 1px solid rgba(255,77,109,.38);
      transform: rotate(45deg);
    }

    /* Year "redesign": stepper-style control (same palette, new UX) */
    .yearPicker{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(18,26,42,.70);
    }
    .yearBtn{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 950;
      padding: 0;
    }
    .yearBtn:active{ transform: scale(.98); }
    .yearInput{
      width: 100%;
      text-align: center;
      font-weight: 950;
      letter-spacing: .3px;
      background: rgba(18,26,42,.85);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
    }
    /* remove native spinners where possible */
    input.yearInput::-webkit-outer-spin-button,
    input.yearInput::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input.yearInput[type=number]{ -moz-appearance: textfield; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="ui_title">–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä–∞</h1>
          <div class="sub" id="ui_sub">–∫–∞—Ç–∞–ª–æ–≥ ‚Ä¢ –≤–∏—à–ª–∏—Å—Ç ‚Ä¢ –∫–æ–ª–ª–µ–∫—Ü–∏—è ‚Ä¢ –∑–∞–º–µ—Ç–∫–∏ ‚Ä¢ import/export JSON</div>
        </div>
      </div>

      <div class="row">
        <div class="tabs" role="tablist" aria-label="–†–µ–∂–∏–º—ã">
          <button class="tab" id="tab_all" role="tab" aria-selected="true" data-view="all">–ö–∞—Ç–∞–ª–æ–≥</button>
          <button class="tab" id="tab_wish" role="tab" aria-selected="false" data-view="wish">–í–∏—à–ª–∏—Å—Ç</button>
          <button class="tab" id="tab_owned" role="tab" aria-selected="false" data-view="owned">–ö–æ–ª–ª–µ–∫—Ü–∏—è</button>
        </div>

        <!-- –≤–∞–ª—é—Ç–∞ (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è) -->
        <select class="btnGhost" id="currency" title="Currency" style="padding: 11px 12px;">
          <option value="CZK">CZK</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="UAH">UAH</option>
          <option value="RUB">RUB</option>
        </select>

        <!-- —è–∑—ã–∫ -->
        <button class="btnGhost" id="langBtn" title="Switch language">RU / EN</button>

        <button class="btn" id="addBtn">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div style="margin-top:12px;" class="controls" role="search">
      <input id="q" placeholder="–ü–æ–∏—Å–∫: –∏–º—è / –ø–µ—Ä—Å–æ–Ω–∞–∂ / –∑–∞–º–µ—Ç–∫–∏ / —Ç–µ–≥–∏‚Ä¶" autocomplete="off"/>
      <select id="brand">
        <option value="all">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
      </select>
      <select id="condition">
        <option value="all">–õ—é–±–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</option>
        <option value="new">–ù–æ–≤–æ–µ</option>
        <option value="good">–•–æ—Ä–æ—à–µ–µ</option>
        <option value="ok">–û–∫</option>
        <option value="bad">–ü–ª–æ—Ö–æ–µ</option>
      </select>
      <select id="sort">
        <option value="recent">–°–æ—Ä—Ç: –Ω–µ–¥–∞–≤–Ω–∏–µ</option>
        <option value="market_desc">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ‚Üì</option>
        <option value="market_asc">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ‚Üë</option>
        <option value="buy_desc">–ü–æ–∫—É–ø–∫–∞: ‚Üì</option>
        <option value="buy_asc">–ü–æ–∫—É–ø–∫–∞: ‚Üë</option>
        <option value="name_asc">–ò–º—è: A‚Üí–Ø</option>
        <option value="name_desc">–ò–º—è: –Ø‚ÜíA</option>
      </select>
      <button class="btnGhost" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button class="btnGhost" id="importBtn">–ò–º–ø–æ—Ä—Ç JSON</button>
      <input id="importFile" type="file" accept="application/json" hidden />
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <span class="pill" id="stats"></span>
      <span class="pill" id="ui_offline">–í—Å—ë –æ—Ñ–ª–∞–π–Ω. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="list" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" style="display:none; margin-top:14px;">
    –ü—É—Å—Ç–æ. –î–æ–±–∞–≤—å –∑–∞–ø–∏—Å—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏ —Ñ–∏–ª—å—Ç—Ä—ã.
  </div>
</main>

<footer class="wrap" id="ui_footer">
  –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å: –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å API/–±–¥ –∏ —Ñ–æ—Ç–∫–∏ –≤–º–µ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∏.
</footer>

<!-- Modal: Add/Edit -->
<div class="modalBackdrop" id="modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modalTop">
      <strong id="mTitle">–î–æ–±–∞–≤–∏—Ç—å</strong>
      <button class="x" id="mClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="modalContent">
      <div class="formGrid">
        <div class="field">
          <label id="l_name">–ù–∞–∑–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ö–æ—á–µ—à—å)</label>
          <input id="f_name" placeholder="–ù–∞–ø—Ä: Draculaura –±–∞–∑–æ–≤–∞—è" />
        </div>
        <div class="field">
          <label id="l_brand">–ë—Ä–µ–Ω–¥</label>
          <select id="f_brand">
            <option>Monster High</option>
            <option>Ever After High</option>
            <option>Barbie</option>
            <option>–î—Ä—É–≥–∏–µ</option>
          </select>
        </div>

        <div class="field">
          <label id="l_line">–õ–∏–Ω–µ–π–∫–∞ / —Å–µ—Ä–∏—è</label>
          <input id="f_line" placeholder="–ù–∞–ø—Ä: G1 / Creeproduction / Signature..." />
        </div>
        <div class="field">
          <label id="l_char">–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
          <input id="f_char" placeholder="–ù–∞–ø—Ä: Frankie / Raven / Barbie..." />
        </div>

        <div class="field">
          <label id="l_year">–ì–æ–¥</label>

          <!-- —Ä–µ–¥–∏–∑–∞–π–Ω –≥–æ–¥–∞: stepper -->
          <div class="yearPicker">
            <button class="yearBtn" id="yearDec" type="button" aria-label="Year minus">‚àí</button>
            <input id="f_year" class="yearInput" type="number" min="1950" max="2100" placeholder="–ù–∞–ø—Ä: 2012" />
            <button class="yearBtn" id="yearInc" type="button" aria-label="Year plus">+</button>
          </div>
        </div>

        <div class="field">
          <label id="l_condition">–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
          <select id="f_condition">
            <option value="new">–ù–æ–≤–æ–µ</option>
            <option value="good">–•–æ—Ä–æ—à–µ–µ</option>
            <option value="ok">–û–∫</option>
            <option value="bad">–ü–ª–æ—Ö–æ–µ</option>
          </select>
        </div>

        <div class="field">
          <label id="l_complete">–ö–æ–º–ø–ª–µ–∫—Ç–Ω–æ—Å—Ç—å</label>
          <select id="f_complete">
            <option value="full">–ü–æ–ª–Ω–∞—è</option>
            <option value="partial">–ß–∞—Å—Ç–∏—á–Ω–∞—è</option>
            <option value="nude">Nude / –±–µ–∑ –æ–¥–µ–∂–¥—ã</option>
            <option value="unknown">–ù–µ –∑–Ω–∞—é</option>
          </select>
        </div>
        <div class="field">
          <label id="l_status">–°—Ç–∞—Ç—É—Å</label>
          <select id="f_status">
            <option value="none">–ü—Ä–æ—Å—Ç–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</option>
            <option value="wish">–í–∏—à–ª–∏—Å—Ç</option>
            <option value="owned">–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏</option>
          </select>
        </div>

        <div class="field">
          <label id="l_buy">–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏</label>
          <input id="f_buy" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä: 950" />
          <div class="help" id="h_buy">–ï—Å–ª–∏ –Ω–µ –ø–æ–∫—É–ø–∞–ª–∞ ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º.</div>
        </div>
        <div class="field">
          <label id="l_market">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Ä—ã–Ω–∫–∞</label>
          <input id="f_market" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä: 1200" />
          <div class="help" id="h_market">–°—é–¥–∞ –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç.</div>
        </div>

        <div class="field full">
          <label id="l_notes">–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea id="f_notes" placeholder="–î–µ—Ñ–µ–∫—Ç—ã, —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è, –≥–¥–µ –ª–µ–∂–∏—Ç, —á—Ç–æ –¥–æ–∫—É–ø–∏—Ç—å..."></textarea>
        </div>

        <div class="field full">
          <label id="l_tags">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input id="f_tags" placeholder="–ù–∞–ø—Ä: g1, rare, box, boots missing" />
        </div>

        <div class="field full" style="display:flex; gap:10px; flex-direction:row; flex-wrap:wrap; margin-top:4px;">
          <button class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btnGhost" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
          <button class="btnDanger" id="deleteBtn" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== LANGUAGE ======
  const LS_LANG = "collector_lang_v1";
  let lang = localStorage.getItem(LS_LANG) || "ru";

  // ====== CURRENCY (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è) ======
  const LS_CUR = "collector_currency_v1";
  let currency = localStorage.getItem(LS_CUR) || "CZK";

  const allowedCurrencies = ["USD","UAH","RUB","CZK","EUR"];
  if(!allowedCurrencies.includes(currency)) currency = "CZK";

  const currencyName = {
    USD: { ru: "–¥–æ–ª–ª–∞—Ä—ã", en: "USD" },
    UAH: { ru: "–≥—Ä–∏–≤–Ω—ã", en: "UAH" },
    RUB: { ru: "—Ä—É–±–ª–∏",  en: "RUB" },
    CZK: { ru: "–∫—Ä–æ–Ω—ã",  en: "CZK" },
    EUR: { ru: "–µ–≤—Ä–æ",   en: "EUR" }
  };

  function localeForLang(){
    return (lang === "ru") ? "ru-RU" : "en-US";
  }

  function formatMoney(n){
    if(n == null || n === "" || Number.isNaN(Number(n))) return t("dash");
    try{
      return new Intl.NumberFormat(localeForLang(), {
        style: "currency",
        currency,
        currencyDisplay: "symbol",
        maximumFractionDigits: 0
      }).format(Number(n));
    }catch{
      // fallback
      return String(Number(n)) + " " + currency;
    }
  }

  const i18n = {
    ru: {
      title: "–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä–∞",
      sub: "–∫–∞—Ç–∞–ª–æ–≥ ‚Ä¢ –≤–∏—à–ª–∏—Å—Ç ‚Ä¢ –∫–æ–ª–ª–µ–∫—Ü–∏—è ‚Ä¢ –∑–∞–º–µ—Ç–∫–∏ ‚Ä¢ import/export JSON",
      tab_all: "–ö–∞—Ç–∞–ª–æ–≥",
      tab_wish: "–í–∏—à–ª–∏—Å—Ç",
      tab_owned: "–ö–æ–ª–ª–µ–∫—Ü–∏—è",
      add: "Ôºã –î–æ–±–∞–≤–∏—Ç—å",
      q_ph: "–ü–æ–∏—Å–∫: –∏–º—è / –ø–µ—Ä—Å–æ–Ω–∞–∂ / –∑–∞–º–µ—Ç–∫–∏ / —Ç–µ–≥–∏‚Ä¶",
      brand_all: "–í—Å–µ –±—Ä–µ–Ω–¥—ã",
      condition_all: "–õ—é–±–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
      c_new: "–ù–æ–≤–æ–µ",
      c_good: "–•–æ—Ä–æ—à–µ–µ",
      c_ok: "–û–∫",
      c_bad: "–ü–ª–æ—Ö–æ–µ",
      sort_recent: "–°–æ—Ä—Ç: –Ω–µ–¥–∞–≤–Ω–∏–µ",
      sort_market_desc: "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ‚Üì",
      sort_market_asc: "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ‚Üë",
      sort_buy_desc: "–ü–æ–∫—É–ø–∫–∞: ‚Üì",
      sort_buy_asc: "–ü–æ–∫—É–ø–∫–∞: ‚Üë",
      sort_name_asc: "–ò–º—è: A‚Üí–Ø",
      sort_name_desc: "–ò–º—è: –Ø‚ÜíA",
      export: "–≠–∫—Å–ø–æ—Ä—Ç JSON",
      import: "–ò–º–ø–æ—Ä—Ç JSON",
      offline: "–í—Å—ë –æ—Ñ–ª–∞–π–Ω. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).",
      empty: "–ü—É—Å—Ç–æ. –î–æ–±–∞–≤—å –∑–∞–ø–∏—Å—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏ —Ñ–∏–ª—å—Ç—Ä—ã.",
      footer: "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å: –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å API/–±–¥ –∏ —Ñ–æ—Ç–∫–∏ –≤–º–µ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∏.",

      m_add: "–î–æ–±–∞–≤–∏—Ç—å",
      m_edit: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",
      l_name: "–ù–∞–∑–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ö–æ—á–µ—à—å)",
      name_ph: "–ù–∞–ø—Ä: Draculaura –±–∞–∑–æ–≤–∞—è",
      l_brand: "–ë—Ä–µ–Ω–¥",
      l_line: "–õ–∏–Ω–µ–π–∫–∞ / —Å–µ—Ä–∏—è",
      line_ph: "–ù–∞–ø—Ä: G1 / Creeproduction / Signature...",
      l_char: "–ü–µ—Ä—Å–æ–Ω–∞–∂",
      char_ph: "–ù–∞–ø—Ä: Frankie / Raven / Barbie...",
      l_year: "–ì–æ–¥",
      year_ph: "–ù–∞–ø—Ä: 2012",
      l_condition: "–°–æ—Å—Ç–æ—è–Ω–∏–µ",
      l_complete: "–ö–æ–º–ø–ª–µ–∫—Ç–Ω–æ—Å—Ç—å",
      comp_full: "–ü–æ–ª–Ω–∞—è",
      comp_partial: "–ß–∞—Å—Ç–∏—á–Ω–∞—è",
      comp_nude: "Nude / –±–µ–∑ –æ–¥–µ–∂–¥—ã",
      comp_unknown: "–ù–µ –∑–Ω–∞—é",
      l_status: "–°—Ç–∞—Ç—É—Å",
      st_none: "–ü—Ä–æ—Å—Ç–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ",
      st_wish: "–í–∏—à–ª–∏—Å—Ç",
      st_owned: "–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
      l_buy: "–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏",
      buy_ph: "–ù–∞–ø—Ä: 950",
      h_buy: "–ï—Å–ª–∏ –Ω–µ –ø–æ–∫—É–ø–∞–ª–∞ ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º.",
      l_market: "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Ä—ã–Ω–∫–∞",
      market_ph: "–ù–∞–ø—Ä: 1200",
      h_market: "–°—é–¥–∞ –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç.",
      l_notes: "–ó–∞–º–µ—Ç–∫–∏",
      notes_ph: "–î–µ—Ñ–µ–∫—Ç—ã, —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è, –≥–¥–µ –ª–µ–∂–∏—Ç, —á—Ç–æ –¥–æ–∫—É–ø–∏—Ç—å...",
      l_tags: "–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)",
      tags_ph: "–ù–∞–ø—Ä: g1, rare, box, boots missing",
      save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
      cancel: "–û—Ç–º–µ–Ω–∞",
      del: "–£–¥–∞–ª–∏—Ç—å",

      year: "–ì–æ–¥",
      complete: "–ö–æ–º–ø–ª–µ–∫—Ç",
      status: "–°—Ç–∞—Ç—É—Å",
      buy: "–ü–æ–∫—É–ø–∫–∞",
      market: "–†—ã–Ω–æ–∫",
      dash: "‚Äî",
      status_catalog: "–ö–∞—Ç–∞–ª–æ–≥",
      btn_to_wish: "–í –≤–∏—à–ª–∏—Å—Ç",
      btn_from_wish: "–£–±—Ä–∞—Ç—å –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞",
      btn_to_owned: "–í –∫–æ–ª–ª–µ–∫—Ü–∏—é",
      btn_from_owned: "–£–±—Ä–∞—Ç—å –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
      btn_edit: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",

      confirm_delete: "–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.",
      err_name_required: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ. –í–ø–∏—à–∏ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ üôÇ",
      err_import: "–ù–µ —Å–º–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª/—Ñ–æ—Ä–º–∞—Ç.",
      ok_import: "–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤."
    },
    en: {
      title: "Collector Catalog",
      sub: "catalog ‚Ä¢ wishlist ‚Ä¢ collection ‚Ä¢ notes ‚Ä¢ import/export JSON",
      tab_all: "Catalog",
      tab_wish: "Wishlist",
      tab_owned: "Collection",
      add: "Ôºã Add",
      q_ph: "Search: name / character / notes / tags‚Ä¶",
      brand_all: "All brands",
      condition_all: "Any condition",
      c_new: "New",
      c_good: "Good",
      c_ok: "OK",
      c_bad: "Bad",
      sort_recent: "Sort: recent",
      sort_market_desc: "Market avg: ‚Üì",
      sort_market_asc: "Market avg: ‚Üë",
      sort_buy_desc: "Buy price: ‚Üì",
      sort_buy_asc: "Buy price: ‚Üë",
      sort_name_asc: "Name: A‚ÜíZ",
      sort_name_desc: "Name: Z‚ÜíA",
      export: "Export JSON",
      import: "Import JSON",
      offline: "Offline. Data is stored in the browser (localStorage).",
      empty: "No items. Add one or change filters.",
      footer: "If you want: easy to plug in API/DB and real photos later.",

      m_add: "Add",
      m_edit: "Edit",
      l_name: "Title (anything)",
      name_ph: "e.g. Basic Draculaura",
      l_brand: "Brand",
      l_line: "Line / series",
      line_ph: "e.g. G1 / Creeproduction / Signature...",
      l_char: "Character",
      char_ph: "e.g. Frankie / Raven / Barbie...",
      l_year: "Year",
      year_ph: "e.g. 2012",
      l_condition: "Condition",
      l_complete: "Completeness",
      comp_full: "Full",
      comp_partial: "Partial",
      comp_nude: "Nude / no outfit",
      comp_unknown: "Not sure",
      l_status: "Status",
      st_none: "Just catalog",
      st_wish: "Wishlist",
      st_owned: "Owned",
      l_buy: "Buy price",
      buy_ph: "e.g. 950",
      h_buy: "Leave empty if not bought.",
      l_market: "Market average",
      market_ph: "e.g. 1200",
      h_market: "You can plug auto-calculation later.",
      l_notes: "Notes",
      notes_ph: "Flaws, restoration, where it is, missing parts...",
      l_tags: "Tags (comma-separated)",
      tags_ph: "e.g. g1, rare, box, boots missing",
      save: "Save",
      cancel: "Cancel",
      del: "Delete",

      year: "Year",
      complete: "Complete",
      status: "Status",
      buy: "Buy",
      market: "Market",
      dash: "‚Äî",
      status_catalog: "Catalog",
      btn_to_wish: "Add to wishlist",
      btn_from_wish: "Remove from wishlist",
      btn_to_owned: "Add to collection",
      btn_from_owned: "Remove from collection",
      btn_edit: "Edit",

      confirm_delete: "Delete this item? This cannot be undone.",
      err_name_required: "Title is empty. Enter something.",
      err_import: "Could not import JSON. Check file/format.",
      ok_import: "Import done."
    }
  };

  function t(key){ return (i18n[lang] && i18n[lang][key]) ? i18n[lang][key] : key; }

  function applyLang(){
    document.documentElement.lang = lang;
    document.title = t("title");

    document.getElementById("ui_title").textContent = t("title");
    document.getElementById("ui_sub").textContent = t("sub");
    document.getElementById("tab_all").textContent = t("tab_all");
    document.getElementById("tab_wish").textContent = t("tab_wish");
    document.getElementById("tab_owned").textContent = t("tab_owned");
    document.getElementById("addBtn").textContent = t("add");
    document.getElementById("q").placeholder = t("q_ph");
    document.getElementById("exportBtn").textContent = t("export");
    document.getElementById("importBtn").textContent = t("import");
    document.getElementById("ui_offline").textContent = t("offline");
    document.getElementById("empty").textContent = t("empty");
    document.getElementById("ui_footer").textContent = t("footer");

    // filters text
    const brandSelect = document.getElementById("brand");
    if(brandSelect){
      const allOpt = [...brandSelect.options].find(o => o.value === "all");
      if(allOpt) allOpt.textContent = t("brand_all");
    }

    const cond = document.getElementById("condition");
    if(cond){
      const map = { all: t("condition_all"), new: t("c_new"), good: t("c_good"), ok: t("c_ok"), bad: t("c_bad") };
      [...cond.options].forEach(o => { if(map[o.value]) o.textContent = map[o.value]; });
    }

    const sort = document.getElementById("sort");
    if(sort){
      const map = {
        recent: t("sort_recent"),
        market_desc: t("sort_market_desc"),
        market_asc: t("sort_market_asc"),
        buy_desc: t("sort_buy_desc"),
        buy_asc: t("sort_buy_asc"),
        name_asc: t("sort_name_asc"),
        name_desc: t("sort_name_desc")
      };
      [...sort.options].forEach(o => { if(map[o.value]) o.textContent = map[o.value]; });
    }

    // modal labels + placeholders
    document.getElementById("mTitle").textContent = (editingId ? t("m_edit") : t("m_add"));
    document.getElementById("l_name").textContent = t("l_name");
    document.getElementById("f_name").placeholder = t("name_ph");
    document.getElementById("l_brand").textContent = t("l_brand");
    document.getElementById("l_line").textContent = t("l_line");
    document.getElementById("f_line").placeholder = t("line_ph");
    document.getElementById("l_char").textContent = t("l_char");
    document.getElementById("f_char").placeholder = t("char_ph");
    document.getElementById("l_year").textContent = t("l_year");
    document.getElementById("f_year").placeholder = t("year_ph");
    document.getElementById("l_condition").textContent = t("l_condition");
    document.getElementById("l_complete").textContent = t("l_complete");
    document.getElementById("l_status").textContent = t("l_status");

    // currency-aware labels inside modal
    const curLabel = currencyName[currency] ? currencyName[currency][lang] : currency;
    document.getElementById("l_buy").textContent = `${t("l_buy")} (${curLabel})`;
    document.getElementById("l_market").textContent = `${t("l_market")} (${curLabel})`;

    document.getElementById("f_buy").placeholder = t("buy_ph");
    document.getElementById("h_buy").textContent = t("h_buy");
    document.getElementById("f_market").placeholder = t("market_ph");
    document.getElementById("h_market").textContent = t("h_market");
    document.getElementById("l_notes").textContent = t("l_notes");
    document.getElementById("f_notes").placeholder = t("notes_ph");
    document.getElementById("l_tags").textContent = t("l_tags");
    document.getElementById("f_tags").placeholder = t("tags_ph");
    document.getElementById("saveBtn").textContent = t("save");
    document.getElementById("cancelBtn").textContent = t("cancel");
    document.getElementById("deleteBtn").textContent = t("del");

    // modal selects: condition
    const fcond = document.getElementById("f_condition");
    if(fcond){
      const map = { new: t("c_new"), good: t("c_good"), ok: t("c_ok"), bad: t("c_bad") };
      [...fcond.options].forEach(o => { if(map[o.value]) o.textContent = map[o.value]; });
    }
    // modal selects: complete
    const fcomp = document.getElementById("f_complete");
    if(fcomp){
      const map = { full: t("comp_full"), partial: t("comp_partial"), nude: t("comp_nude"), unknown: t("comp_unknown") };
      [...fcomp.options].forEach(o => { if(map[o.value]) o.textContent = map[o.value]; });
    }
    // modal selects: status
    const fstat = document.getElementById("f_status");
    if(fstat){
      const map = { none: t("st_none"), wish: t("st_wish"), owned: t("st_owned") };
      [...fstat.options].forEach(o => { if(map[o.value]) o.textContent = map[o.value]; });
    }

    render();
  }

  // ====== STORAGE ======
  const LS_KEY = "collector_catalog_v1";

  // Example seed if empty
  function uid(){
    return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  const seed = [
    {
      id: uid(),
      createdAt: Date.now() - 1000*60*60*24*6,
      name: "Draculaura ‚Äî –±–∞–∑–æ–≤–∞—è",
      brand: "Monster High",
      line: "G1",
      character: "Draculaura",
      year: 2012,
      condition: "good",
      complete: "partial",
      status: "owned",
      buyPrice: 950,
      marketPrice: 1400,
      notes: "–ß—É—Ç—å –ø—É—à–∞—Ç—Å—è –≤–æ–ª–æ—Å—ã. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ–¥–Ω–æ–π —Å–µ—Ä—ë–∂–∫–∏.",
      tags: ["g1","monster high","pink"]
    },
    {
      id: uid(),
      createdAt: Date.now() - 1000*60*60*24*2,
      name: "Raven Queen ‚Äî wishlist",
      brand: "Ever After High",
      line: "Signature",
      character: "Raven Queen",
      year: 2014,
      condition: "good",
      complete: "full",
      status: "wish",
      buyPrice: null,
      marketPrice: 1800,
      notes: "–•–æ—á—É –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç –∏ –∫–æ—Ä–æ–±–∫—É –µ—Å–ª–∏ –ø–æ–≤–µ–∑—ë—Ç.",
      tags: ["eah","wishlist","rare?"]
    },
    {
      id: uid(),
      createdAt: Date.now() - 1000*60*60*12,
      name: "Outfit set",
      brand: "Barbie",
      line: "Fashion",
      character: "‚Äî",
      year: 2020,
      condition: "new",
      complete: "full",
      status: "none",
      buyPrice: 250,
      marketPrice: 300,
      notes: "–ü–æ–¥ 11.5\" —Ñ–æ—Ä–º–∞—Ç.",
      tags: ["barbie","outfit"]
    }
  ];

  function loadDB(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        localStorage.setItem(LS_KEY, JSON.stringify(seed));
        return seed.slice();
      }
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) throw new Error("bad db");
      return arr;
    }catch{
      localStorage.setItem(LS_KEY, JSON.stringify(seed));
      return seed.slice();
    }
  }
  function saveDB(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }

  // ====== small popup near input ======
  let errorPopEl = null;
  let errorPopTimer = null;

  function showErrorNear(el, message){
    if(!el) return;
    if(!errorPopEl){
      errorPopEl = document.createElement("div");
      errorPopEl.className = "errorPop";
      document.body.appendChild(errorPopEl);
    }
    errorPopEl.textContent = message;

    const r = el.getBoundingClientRect();
    const top = r.bottom + 10;
    let left = r.left;
    const maxW = 320;
    const vw = window.innerWidth;
    if(left + maxW > vw - 12) left = Math.max(12, vw - maxW - 12);
    if(left < 12) left = 12;

    errorPopEl.style.top = top + "px";
    errorPopEl.style.left = left + "px";

    requestAnimationFrame(()=> errorPopEl.classList.add("show"));

    clearTimeout(errorPopTimer);
    errorPopTimer = setTimeout(()=> errorPopEl.classList.remove("show"), 2200);
  }

  // ====== STATE ======
  let db = loadDB();
  let view = "all"; // all | wish | owned
  let editingId = null;

  // ====== DOM ======
  const $ = (s) => document.querySelector(s);

  const listEl = $("#list");
  const emptyEl = $("#empty");
  const statsEl = $("#stats");

  const qEl = $("#q");
  const brandEl = $("#brand");
  const conditionEl = $("#condition");
  const sortEl = $("#sort");

  const addBtn = $("#addBtn");
  const exportBtn = $("#exportBtn");
  const importBtn = $("#importBtn");
  const importFile = $("#importFile");
  const langBtn = $("#langBtn");

  const currencyEl = $("#currency");

  // tabs
  const tabs = [...document.querySelectorAll(".tab")];

  // modal
  const modal = $("#modal");
  const mTitle = $("#mTitle");
  const mClose = $("#mClose");
  const saveBtn = $("#saveBtn");
  const cancelBtn = $("#cancelBtn");
  const deleteBtn = $("#deleteBtn");

  // year stepper buttons
  const yearDec = $("#yearDec");
  const yearInc = $("#yearInc");

  // form fields
  const f = {
    name: $("#f_name"),
    brand: $("#f_brand"),
    line: $("#f_line"),
    char: $("#f_char"),
    year: $("#f_year"),
    condition: $("#f_condition"),
    complete: $("#f_complete"),
    status: $("#f_status"),
    buy: $("#f_buy"),
    market: $("#f_market"),
    notes: $("#f_notes"),
    tags: $("#f_tags"),
  };

  // ====== INIT FILTERS ======
  function rebuildBrandFilter(){
    const brands = ["all", ...Array.from(new Set(db.map(x => x.brand).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ru'))];
    const current = brandEl.value || "all";
    brandEl.innerHTML = "";
    for(const b of brands){
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b === "all" ? t("brand_all") : b;
      brandEl.appendChild(opt);
    }
    brandEl.value = brands.includes(current) ? current : "all";
  }

  // ====== HELPERS ======
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function condLabel(c){
    if(c==="new") return t("c_new");
    if(c==="good") return t("c_good");
    if(c==="ok") return t("c_ok");
    if(c==="bad") return t("c_bad");
    return t("dash");
  }

  function condClass(c){
    if(c==="new" || c==="good") return "ok";
    if(c==="ok") return "warn";
    if(c==="bad") return "bad";
    return "";
  }

  function completeLabel(v){
    if(v==="full") return t("comp_full");
    if(v==="partial") return t("comp_partial");
    if(v==="nude") return t("comp_nude");
    if(v==="unknown") return t("comp_unknown");
    return t("dash");
  }

  function statusLabel(s){
    if(s==="wish") return t("st_wish");
    if(s==="owned") return t("st_owned");
    return t("status_catalog");
  }

  function matchesQuery(item, q){
    if(!q) return true;
    const hay = [
      item.name, item.brand, item.line, item.character,
      item.notes, (item.tags||[]).join(" "),
      String(item.year ?? "")
    ].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase().trim());
  }

  function getFiltered(){
    const q = qEl.value.trim();
    const b = brandEl.value;
    const c = conditionEl.value;

    let arr = db.slice();

    if(view === "wish") arr = arr.filter(x => x.status === "wish");
    if(view === "owned") arr = arr.filter(x => x.status === "owned");

    arr = arr.filter(x => matchesQuery(x, q));
    if(b !== "all") arr = arr.filter(x => x.brand === b);
    if(c !== "all") arr = arr.filter(x => x.condition === c);

    const s = sortEl.value;
    const byName = (a,b)=> (a.name||"").localeCompare(b.name||"",'ru');

    if(s === "recent") arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    else if(s === "market_desc") arr.sort((a,b)=>(Number(b.marketPrice)||-1)-(Number(a.marketPrice)||-1));
    else if(s === "market_asc") arr.sort((a,b)=>(Number(a.marketPrice)||1e18)-(Number(b.marketPrice)||1e18));
    else if(s === "buy_desc") arr.sort((a,b)=>(Number(b.buyPrice)||-1)-(Number(a.buyPrice)||-1));
    else if(s === "buy_asc") arr.sort((a,b)=>(Number(a.buyPrice)||1e18)-(Number(b.buyPrice)||1e18));
    else if(s === "name_asc") arr.sort(byName);
    else if(s === "name_desc") arr.sort((a,b)=>byName(b,a));

    return arr;
  }

  function setStats(visible){
    const total = db.length;
    const wish = db.filter(x=>x.status==="wish").length;
    const owned = db.filter(x=>x.status==="owned").length;

    const mode =
      view === "all" ? t("tab_all") :
      view === "wish" ? t("tab_wish") :
      t("tab_owned");

    statsEl.textContent = `${mode}: ${visible}/${total} ‚Ä¢ wish: ${wish} ‚Ä¢ owned: ${owned}`;
  }

  // ====== RENDER ======
  function render(){
    rebuildBrandFilter();

    const arr = getFiltered();
    listEl.innerHTML = "";

    emptyEl.style.display = arr.length ? "none" : "block";
    setStats(arr.length);

    for(const it of arr){
      const card = document.createElement("article");
      card.className = "card";

      const cond = condLabel(it.condition);
      const condCls = condClass(it.condition);

      const title = it.name || (lang==="ru" ? "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)" : "(no title)");
      const meta1 = `${it.brand || t("dash")} ‚Ä¢ ${it.line || t("dash")} ‚Ä¢ ${it.character || t("dash")}`;

      const meta2 =
        `${t("year")}: ${it.year ?? t("dash")} ‚Ä¢ ${t("complete")}: ${completeLabel(it.complete)} ‚Ä¢ ${t("status")}: ${statusLabel(it.status)}`;

      card.innerHTML = `
        <div class="thumb">
          <span class="badge ${condCls}">${esc(cond)}</span>
          <span class="badge">${esc(statusLabel(it.status))}</span>
        </div>
        <div class="body">
          <div class="titleRow">
            <h3 class="title">${esc(title)}</h3>
          </div>
          <div class="metaLine">${esc(meta1)}</div>
          <div class="metaLine">${esc(meta2)}</div>

          <div class="money">
            <span>${esc(t("buy"))}: <b>${esc(formatMoney(it.buyPrice))}</b></span>
            <span>${esc(t("market"))}: <b>${esc(formatMoney(it.marketPrice))}</b></span>
          </div>

          <div class="actions">
            <button class="btnGhost" data-action="toggleWish" data-id="${it.id}">
              ${it.status === "wish" ? esc(t("btn_from_wish")) : esc(t("btn_to_wish"))}
            </button>
            <button class="btnGhost" data-action="toggleOwned" data-id="${it.id}">
              ${it.status === "owned" ? esc(t("btn_from_owned")) : esc(t("btn_to_owned"))}
            </button>
            <button class="btn" data-action="edit" data-id="${it.id}">${esc(t("btn_edit"))}</button>
          </div>
        </div>
      `;

      listEl.appendChild(card);
    }
  }

  // ====== TABS ======
  function setView(next){
    view = next;
    for(const tbtn of tabs){
      const selected = tbtn.dataset.view === view;
      tbtn.setAttribute("aria-selected", selected ? "true" : "false");
    }
    render();
  }
  tabs.forEach(tbtn => tbtn.addEventListener("click", ()=> setView(tbtn.dataset.view)));

  // ====== MODAL LOGIC ======
  function openModal(mode, item){
    modal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";

    if(mode === "add"){
      mTitle.textContent = t("m_add");
      editingId = null;
      deleteBtn.style.display = "none";
      fillForm({
        name:"", brand:"Monster High", line:"", character:"", year:"",
        condition:"good", complete:"full", status:"none",
        buyPrice:"", marketPrice:"", notes:"", tags:[]
      });
    } else {
      mTitle.textContent = t("m_edit");
      editingId = item.id;
      deleteBtn.style.display = "inline-block";
      fillForm(item);
    }

    // –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª—é—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –≤ –º–æ–¥–∞–ª–∫–µ
    applyLang();
  }

  function closeModal(){
    modal.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
    editingId = null;
  }

  function fillForm(item){
    f.name.value = item.name ?? "";
    f.brand.value = item.brand ?? "–î—Ä—É–≥–∏–µ";
    f.line.value = item.line ?? "";
    f.char.value = item.character ?? "";
    f.year.value = item.year ?? "";
    f.condition.value = item.condition ?? "good";
    f.complete.value = item.complete ?? "unknown";
    f.status.value = item.status ?? "none";
    f.buy.value = item.buyPrice ?? "";
    f.market.value = item.marketPrice ?? "";
    f.notes.value = item.notes ?? "";
    f.tags.value = (item.tags || []).join(", ");
  }

  function readForm(){
    const year = f.year.value === "" ? null : Number(f.year.value);
    const buy = f.buy.value === "" ? null : Number(f.buy.value);
    const market = f.market.value === "" ? null : Number(f.market.value);

    const tags = f.tags.value
      .split(",")
      .map(x=>x.trim())
      .filter(Boolean);

    return {
      name: f.name.value.trim(),
      brand: f.brand.value,
      line: f.line.value.trim(),
      character: f.char.value.trim(),
      year: (year != null && !Number.isNaN(year)) ? year : null,
      condition: f.condition.value,
      complete: f.complete.value,
      status: f.status.value,
      buyPrice: (buy != null && !Number.isNaN(buy)) ? buy : null,
      marketPrice: (market != null && !Number.isNaN(market)) ? market : null,
      notes: f.notes.value.trim(),
      tags
    };
  }

  // ====== CRUD ======
  function addItem(){
    openModal("add", null);
    setTimeout(()=> f.name.focus(), 0);
  }

  function editItem(id){
    const item = db.find(x => x.id === id);
    if(!item) return;
    openModal("edit", item);
    setTimeout(()=> f.name.focus(), 0);
  }

  function saveItem(){
    const data = readForm();

    if(!data.name){
      showErrorNear(f.name, t("err_name_required"));
      f.name.focus();
      return;
    }

    if(editingId){
      const idx = db.findIndex(x=>x.id===editingId);
      if(idx === -1) return;
      db[idx] = { ...db[idx], ...data };
    } else {
      db.unshift({
        id: uid(),
        createdAt: Date.now(),
        ...data
      });
    }

    saveDB(db);
    closeModal();
    render();
  }

  function deleteItem(){
    if(!editingId) return;
    const ok = confirm(t("confirm_delete"));
    if(!ok) return;

    db = db.filter(x=>x.id !== editingId);
    saveDB(db);
    closeModal();
    render();
  }

  function toggleWish(id){
    const item = db.find(x=>x.id===id);
    if(!item) return;
    item.status = (item.status === "wish") ? "none" : "wish";
    saveDB(db);
    render();
  }

  function toggleOwned(id){
    const item = db.find(x=>x.id===id);
    if(!item) return;
    item.status = (item.status === "owned") ? "none" : "owned";
    saveDB(db);
    render();
  }

  // ====== EXPORT / IMPORT ======
  function exportJSON(){
    const payload = {
      version: 1,
      lang,
      currency,
      exportedAt: new Date().toISOString(),
      items: db
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "collector_catalog_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSONFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(String(reader.result || ""));
        const arr = Array.isArray(parsed) ? parsed : parsed.items;
        if(!Array.isArray(arr)) throw new Error("bad format");

        // optional: import currency/lang if present
        if(parsed && typeof parsed === "object"){
          if(typeof parsed.lang === "string") lang = (parsed.lang === "en" ? "en" : "ru");
          if(typeof parsed.currency === "string" && allowedCurrencies.includes(parsed.currency)) currency = parsed.currency;
          localStorage.setItem(LS_LANG, lang);
          localStorage.setItem(LS_CUR, currency);
          currencyEl.value = currency;
        }

        const norm = arr.map(x => ({
          id: x.id || uid(),
          createdAt: x.createdAt || Date.now(),
          name: x.name || "",
          brand: x.brand || "–î—Ä—É–≥–∏–µ",
          line: x.line || "",
          character: x.character || "",
          year: x.year ?? null,
          condition: x.condition || "ok",
          complete: x.complete || "unknown",
          status: (x.status==="wish"||x.status==="owned"||x.status==="none") ? x.status : "none",
          buyPrice: (x.buyPrice == null) ? null : Number(x.buyPrice),
          marketPrice: (x.marketPrice == null) ? null : Number(x.marketPrice),
          notes: x.notes || "",
          tags: Array.isArray(x.tags) ? x.tags : []
        }));

        db = norm;
        saveDB(db);
        closeModal();
        applyLang();

        showErrorNear(qEl, t("ok_import"));
      }catch{
        showErrorNear(qEl, t("err_import"));
      }
    };
    reader.readAsText(file);
  }

  // ====== YEAR STEPPER (–Ω–æ–≤–∞—è UX –¥–ª—è –≥–æ–¥–∞) ======
  function clampYear(y){
    const min = Number(f.year.min || 1950);
    const max = Number(f.year.max || 2100);
    if(Number.isNaN(y)) return null;
    return Math.min(max, Math.max(min, y));
  }
  function stepYear(delta){
    const cur = (f.year.value === "" ? new Date().getFullYear() : Number(f.year.value));
    const next = clampYear(cur + delta);
    if(next == null) return;
    f.year.value = String(next);
    f.year.dispatchEvent(new Event("input"));
  }

  // ====== EVENTS ======
  addBtn.addEventListener("click", addItem);
  exportBtn.addEventListener("click", exportJSON);

  importBtn.addEventListener("click", () => importFile.click());
  importFile.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(file) importJSONFile(file);
    importFile.value = "";
  });

  qEl.addEventListener("input", render);
  brandEl.addEventListener("change", render);
  conditionEl.addEventListener("change", render);
  sortEl.addEventListener("change", render);

  listEl.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-action]");
    if(!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;

    if(action === "edit") editItem(id);
    if(action === "toggleWish") toggleWish(id);
    if(action === "toggleOwned") toggleOwned(id);
  });

  mClose.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  saveBtn.addEventListener("click", saveItem);
  deleteBtn.addEventListener("click", deleteItem);

  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeModal();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && modal.getAttribute("aria-hidden")==="false") closeModal();
  });

  // Enter to save (in modal)
  modal.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && (e.target.tagName === "INPUT")){
      e.preventDefault();
      saveItem();
    }
  });

  // language toggle
  langBtn.addEventListener("click", ()=>{
    lang = (lang === "ru") ? "en" : "ru";
    localStorage.setItem(LS_LANG, lang);
    applyLang();
  });

  // currency selection
  currencyEl.value = currency;
  currencyEl.addEventListener("change", ()=>{
    const v = currencyEl.value;
    if(allowedCurrencies.includes(v)){
      currency = v;
      localStorage.setItem(LS_CUR, currency);
      applyLang(); // re-render + relabel modal fields
    }
  });

  // year stepper buttons + keyboard support
  yearDec.addEventListener("click", ()=> stepYear(-1));
  yearInc.addEventListener("click", ()=> stepYear(+1));
  f.year.addEventListener("keydown", (e)=>{
    if(e.key === "ArrowUp"){ e.preventDefault(); stepYear(+1); }
    if(e.key === "ArrowDown"){ e.preventDefault(); stepYear(-1); }
  });

  // ====== START ======
  rebuildBrandFilter();
  applyLang();
</script>
</body>
</html>
